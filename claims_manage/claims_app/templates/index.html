{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Claims Management</title>
    <link rel="stylesheet" href="{% static 'claims_app/css/style.css' %}">
     <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="{% static 'claims_app/store.js' %}"></script>
    <script src="{% static 'claims_app/scripts.js' %}"></script>
    <script src="{% static 'claims_app/list.js' %}"></script>
    <script defer src="https://unpkg.com/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/htmx.org@2.x.x"></script>
</head>
<body>
    <div class="row row1">
        <div class="search-animated">
            <input type="text" class="form-control" placeholder="Search by Name or Claim ID">
            <button class="search-btn" type="button">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <!-- Enhanced filter button with active filters indicator -->
        <button class="filter-btn" x-data @click="$store.modalStore.openModal = true" 
                :class="{ 'filter-active': $store.modalStore.hasActiveFilters() }">
            <i class="fa-solid fa-filter fa-xl"></i>
            <!-- Show count of active filters -->
            <template x-if="$store.modalStore.hasActiveFilters()">
                <span class="filter-count" x-text="Object.values($store.modalStore.filters).filter(v => v !== '').length"></span>
            </template>
        </button>
        
        <!-- Clear filters button (only shown when filters are active) -->
        <template x-if="$store.modalStore.hasActiveFilters()">
            <button class="clear-filters-btn" @click="document.dispatchEvent(new CustomEvent('filtersCleared'))" 
                    title="Clear all filters">
                <i class="fas fa-times"></i>
                Clear Filters
            </button>
        </template>
    </div>

    <!-- Enhanced modal with proper form structure -->
    <div x-data="modalApp()" x-show="$store.modalStore.openModal" x-transition class="modal-overlay" 
         @click.self="$store.modalStore.openModal = false">
        <div class="modal-content" @click.stop>
            <div class="modal-header">
                <h2 class="modal-title">Advanced Search & Filter</h2>
                <button class="modal-close" @click="$store.modalStore.openModal = false">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Filter By Section -->
                <div class="modal-section">
                    <h3 class="section-title">
                        <i class="fas fa-filter"></i>
                        Filter By
                    </h3>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status">
                            <option value="">All Statuses</option>
                            <option value="Denied">Denied</option>
                            <option value="Under Review">Under Review</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Insurer</label>
                        <select class="form-select" name="insurer">
                            <option value="">All Insurers</option>
                            <option value="United Healthcare">United Healthcare</option>
                            <option value="Blue Cross">Blue Cross</option>
                            <option value="Cigna">Cigna</option>
                            <option value="Self Funded Inc.">Self Funded Inc.</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Date Range</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="date" class="form-input" name="dateFrom" style="flex: 1;">
                            <span style="align-self: center; color: #6b7280;">to</span>
                            <input type="date" class="form-input" name="dateTo" style="flex: 1;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Paid Amount</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input name="paid" type="number" class="form-input" name="paidMin" placeholder="Min" style="flex: 1;">
                            <span style="align-self: center; color: #6b7280;">to</span>
                            <input name="paid" type="number" class="form-input" name="paidMax" placeholder="Max" style="flex: 1;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Billed Amount</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input name="billed" type="number" class="form-input" name="amountMin" placeholder="Min" style="flex: 1;">
                            <span style="align-self: center; color: #6b7280;">to</span>
                            <input name="billed" type="number" class="form-input" name="amountMax" placeholder="Max" style="flex: 1;">
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-secondary" @click="clearFilters()">
                        Clear All
                    </button>
                    <button class="btn btn-secondary" @click="$store.modalStore.openModal = false">
                        Cancel
                    </button>
                    <button class="btn btn-primary" @click="applyFilters()">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row row2">
        <div class="patients" x-data="listApp()" x-init="fetchList()">
            <!-- Show active filters indicator -->
            <div x-show="hasActiveFilters()" class="active-filters-bar">
                <div class="active-filters-content">
                    <i class="fas fa-filter"></i>
                    <span x-text="`${getActiveFiltersCount()} filter(s) active`"></span>
                    <button class="clear-filters-small" @click="document.dispatchEvent(new CustomEvent('filtersCleared'))">
                        Clear all
                    </button>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Patient Name</th>
                        <th>Billed Amount</th>
                        <th>Paid Amount</th>
                        <th>Status</th>
                        <th>Insurer</th>
                        <th>Discharge Date</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Show search results count when in search mode -->
                    <tr x-show="isSearchMode && list.length > 0">
                        <td colspan="7" class="text-center" style="font-weight: bold; background-color: #f0f9ff; padding: 10px;">
                            Found <span x-text="list.length"></span> result(s) for "<span x-text="searchTerm"></span>"
                            <button @click="clearSearch()" style="margin-left: 10px; background: #ef4444; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer;">Clear Search</button>
                        </td>
                    </tr>

                    <template x-for="patient in list" :key="patient.id">
                        <tr :hx-get="`/api/details/?claim_id_id=${patient.id}`" 
                        hx-swap="none" 
                        style="cursor:pointer" 
                        role="button"
                        @click="selectPatient(patient); $store.patientData.selectPatient(patient)"
                        x-init="htmx.process($el)">
                            <td x-text="patient.id"></td>
                            <td x-text="patient.patient_name"></td>
                            <td x-text="patient.billed_amount"></td>
                            <td x-text="patient.paid_amount"></td>
                            <td x-text="patient.status"></td>
                            <td x-text="patient.insurer_name"></td>
                            <td x-text="patient.discharge_date"></td>
                        </tr>
                    </template>

                    <!-- Show infinite scroll loader only when not in search mode -->
                    <tr x-show="shouldShowLoader()" x-intersect="fetchList()">
                        <td colspan="7" class="text-center">Loading more...</td>
                    </tr>
                    
                    <!-- Show message when no search results -->
                    <tr x-show="isSearchMode && list.length === 0 && !loading">
                        <td colspan="7" class="text-center" style="padding: 20px; color: #6b7280;">
                            No results found for "<span x-text="searchTerm"></span>"
                            <button @click="clearSearch()" style="margin-left: 10px; background: #ef4444; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer;">Clear Search</button>
                        </td>
                    </tr>

                    <!-- Show loading state during search -->
                    <tr x-show="isSearchMode && loading">
                        <td colspan="7" class="text-center">Searching...</td>
                    </tr>
                    
                    <!-- Show no results when filters return empty -->
                    <tr x-show="!isSearchMode && !loading && list.length === 0 && hasActiveFilters()">
                        <td colspan="7" class="text-center" style="padding: 20px; color: #6b7280;">
                            No results match your current filters.
                            <button @click="document.dispatchEvent(new CustomEvent('filtersCleared'))" 
                                    style="margin-left: 10px; background: #ef4444; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer;">
                                Clear Filters
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="row row3" x-data="{}">
        <template x-if="$store.patientData.selectedPatient">
            <div class="card-medical">
                <div class="card-header">
                    <h3 x-text="$store.patientData.selectedPatient?.patient_name" class="patient-name"></h3>
                    <span x-text="$store.patientData.selectedPatient?.status" 
                    x-bind:class="'s ' + $store.patientData.selectedPatient?.status.toLowerCase().replace(' ', '-')"
                    ></span>
                </div>

                <div class="claim-info">
                    <strong>Claim ID:</strong> <span x-text="$store.patientData.selectedPatient?.id"></span><br>
                    <strong>Discharge:</strong> <span x-text="$store.patientData.selectedPatient?.discharge_date"></span>
                </div>

                <div class="financial-summary">
                    <div class="amount-card">
                        <div class="amount-value billed">
                            <span x-text="$store.patientData.selectedPatient?.billed_amount"></span>
                        </div>
                        <div class="amount-label">Billed</div>
                    </div>
                    <div class="amount-card">
                        <div class="amount-value paid-info">
                            <span x-text="$store.patientData.selectedPatient?.paid_amount"></span>
                        </div>
                        <div class="amount-label">Paid</div>
                    </div>
                </div>

                <div class="insurer-info">
                    <strong>Insurer:</strong> <span x-text="$store.patientData.selectedPatient?.insurer_name"></span>
                </div>
                
                <template x-if="$store.patientData.additionalDetails && !$store.patientData.loadingDetails">
                    <div class="insurer-info">
                        <strong>CPT Codes:</strong> <span x-text="$store.patientData.additionalDetails.cpt_codes || 'N/A'"></span>
                    </div>
                </template>
                
                <template x-if="$store.patientData.loadingDetails">
                    <div class="insurer-info">
                        <strong>CPT Codes:</strong> <span>Loading...</span>
                    </div>
                </template>
                
                <template x-if="$store.patientData.additionalDetails && !$store.patientData.loadingDetails">
                    <div class="issue-alert" style="margin-top: 0px">
                        <strong>Issue:</strong>
                        <small x-text="$store.patientData.additionalDetails.denial_reason || 'N/A'"></small>
                    </div>
                </template>
            </div>
        </template>
        
        <!-- Placeholder for the details card -->
        <template x-if="!$store.patientData.selectedPatient">
            <div class="card-medical">
                <h3 class="card-header">Choose a claim from the table</h3>
            </div>
        </template>
        
        <div class="card-notes">
            <div class="notes-section">
                <div class="section-header">
                    <i class="fas fa-sticky-note"></i>
                    <h4>Notes & Annotations</h4>
                </div>
                
                <div class="note-item admin-note">
                    <div class="note-header">
                        <span class="note-type">Admin Note</span>
                        <span class="note-time">2 days ago</span>
                    </div>
                    <p class="note-content">Requires additional medical records for processing. Contacted provider.</p>
                </div>
                
                <div class="note-item system-flag">
                    <div class="note-header">
                        <span class="note-type b">System Flag</span>
                        <span class="note-time">1 week ago</span>
                    </div>
                    <p class="note-content">Potential underpayment detected - review recommended.</p>
                </div>
            </div>
            
            <div class="actions-section">
                <div class="section-header">
                    <h4>Quick Actions</h4>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn">
                        <i class="fas fa-flag"></i>
                        Flag for Review
                    </button>
                    <button class="action-btn">
                        <i class="fas fa-plus"></i>
                        Add Note
                    </button>
                    <button class="action-btn">
                        <i class="fas fa-file-alt"></i>
                        Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
